name: Test Rsyslog + Loki Stack

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate-stack:
    runs-on: ubuntu-latest
    name: "Simulate two Ubuntu devices (server & client)"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure Ubuntu
        run: |
          echo "[CHECKING RUNNER OS]"
          if [[ "$(lsb_release -is)" != "Ubuntu" ]]; then
            echo "Not running on Ubuntu - aborting."
            exit 1
          fi
          echo "Ubuntu confirmed"

      - name: Install Docker
        run: |
          sudo apt-get update -y
          sudo apt-get install -y docker.io
          sudo systemctl start docker
          sudo systemctl enable docker
          docker --version

      - name: Build rsyslog-server container
        run: |
          mkdir -p ./server
          cp ./automateSetup.sh ./server/
          cat > ./server/Dockerfile <<'EOF'
          FROM ubuntu:22.04
          ENV DEBIAN_FRONTEND=noninteractive
          RUN apt-get update -y && apt-get install -y sudo systemctl
          # remove preinstalled containerd to avoid Docker conflicts
          RUN apt-get remove -y containerd || true
          COPY automateSetup.sh /root/automateSetup.sh
          RUN chmod +x /root/automateSetup.sh && bash /root/automateSetup.sh
          EXPOSE 514/tcp 514/udp 3100 3000
          CMD ["sleep","infinity"]
          EOF
          docker build -t rsyslog-server ./server

      - name: Build rsyslog-client container
        run: |
          mkdir -p ./client
          cat > ./client/Dockerfile <<'EOF'
          FROM ubuntu:22.04
          ENV DEBIAN_FRONTEND=noninteractive
          RUN apt-get update -y && apt-get install -y rsyslog curl
          COPY send-remote.sh /root/send-remote.sh
          RUN chmod +x /root/send-remote.sh
          CMD ["sleep","infinity"]
          EOF

          # simple script that sends logs to rsyslog-server
          cat > ./client/send-remote.sh <<'EOF'
          #!/usr/bin/env bash
          set -e
          echo "[CONFIGURING RSYSLOG CLIENT]"
          echo "*.* @@rsyslog-server:514" > /etc/rsyslog.d/50-remote.conf
          service rsyslog restart
          logger "This is a test log from rsyslog client at $(date)"
          EOF

          docker build -t rsyslog-client ./client

      - name: Run containers and test log flow
        run: |
          echo "[Starting containers on shared network]"
          docker network create lognet
          docker run -d --name rsyslog-server --network lognet rsyslog-server
          sleep 25
          docker run -d --name rsyslog-client --network lognet rsyslog-client
          sleep 10
          echo "[Sending test log]"
          docker exec rsyslog-client bash /root/send-remote.sh
          echo "[Waiting for log delivery]"
          sleep 15
          echo "[Inspecting server log directory]"
          docker exec rsyslog-server bash -c "ls -l /var/log/remote || true"
          echo "[Reading received logs]"
          docker exec rsyslog-server bash -c "cat /var/log/remote/*.log || echo 'No logs found'"
          echo "[Checking Loki readiness]"
          docker exec rsyslog-server bash -c "curl -s http://localhost:3100/ready || echo 'Loki not responding yet.'"

      - name: Cleanup
        if: always()
        run: |
          docker rm -f rsyslog-client rsyslog-server || true
          docker network rm lognet || true
