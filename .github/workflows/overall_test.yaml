name: Test Rsyslog Setup (VM mode)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  ubuntu-test:
    runs-on: ubuntu-latest
    name: "Run automateSetup.sh directly on Ubuntu VM"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make shell scripts executable
        run: |
          chmod +x *.sh || true
          chmod +x scripts/*.sh || true

      - name: Run setup script
        run: |
          echo "[RUNNING SETUP SCRIPT ON UBUNTU VM]"
          ./automateSetup.sh

      - name: Verify rsyslog service
        run: |
          echo "[CHECKING RSYSLOG STATUS]"
          sudo systemctl status rsyslog --no-pager || true

      - name: Verify Docker containers
        run: |
          echo "[CHECKING RUNNING CONTAINERS]"
          sudo docker ps -a
          echo "[CHECKING LOKI READINESS]"
          curl -s http://localhost:3100/ready || echo "Loki not ready yet."

      - name: Verify Grafana availability
        run: |
          echo "[VERIFYING GRAFANA STATUS]"
          sudo docker logs grafana || true
          echo "[CHECKING PORT 3000]"
          sudo ss -tuln | grep 3000 || echo "Grafana port not open"
