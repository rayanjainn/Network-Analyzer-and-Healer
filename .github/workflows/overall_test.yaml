name: Validate Full Rsyslog + Loki Stack

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-server:
    runs-on: ubuntu-latest
    name: "Build & Setup Rsyslog Stack Container"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Docker
        run: |
          sudo apt-get update -y
          sudo apt-get remove -y containerd || true
          sudo apt-get install -y docker.io
          sudo systemctl start docker
          sudo systemctl enable docker
          docker --version

      - name: Build rsyslog-server container
        run: |
          mkdir -p ./server
          cp ./automateSetup.sh ./server/
          cat > ./server/Dockerfile <<'EOF'
          FROM ubuntu:22.04
          ENV DEBIAN_FRONTEND=noninteractive
          RUN apt-get update -y && apt-get install -y sudo systemctl curl
          COPY automateSetup.sh /root/automateSetup.sh
          RUN chmod +x /root/automateSetup.sh && bash /root/automateSetup.sh
          EXPOSE 514/tcp 514/udp 3100 3000
          CMD ["sleep","infinity"]
          EOF
          docker build -t rsyslog-server ./server

      - name: Run rsyslog-server container
        run: |
          docker network create lognet || true
          docker run -d --name rsyslog-server --network lognet rsyslog-server
          echo "Waiting for services to initialize..."
          sleep 25
          docker ps -a

  test-grafana:
    runs-on: ubuntu-latest
    needs: build-server
    name: "Test Grafana Health"

    steps:
      - name: Install Docker
        run: |
          sudo apt-get update -y
          sudo apt-get install -y docker.io
          sudo systemctl start docker
      - name: Attach to existing container network
        run: |
          docker network create lognet || true
      - name: Load rsyslog-server image from previous job
        uses: actions/download-artifact@v4
        with:
          name: rsyslog-server
        continue-on-error: true
      - name: Check Grafana health
        run: |
          echo "[Checking Grafana health endpoint]"
          docker ps || true
          docker exec rsyslog-server curl -s http://localhost:3000/api/health || echo "Grafana not responding"

  test-loki-promtail:
    runs-on: ubuntu-latest
    needs: build-server
    name: "Test Loki + Promtail Connection"

    steps:
      - name: Install Docker
        run: |
          sudo apt-get update -y
          sudo apt-get install -y docker.io
          sudo systemctl start docker
      - name: Verify Loki readiness
        run: |
          echo "[Checking Loki readiness]"
          docker exec rsyslog-server curl -s http://localhost:3100/ready || echo "Loki not ready"
      - name: Check Promtail logs
        run: |
          echo "[Inspecting Promtail logs for connection to Loki]"
          docker exec rsyslog-server docker logs promtail 2>&1 | grep -i "loki" || echo "No Loki connection logs found"

  test-rsyslog:
    runs-on: ubuntu-latest
    needs: build-server
    name: "Test Rsyslog Status & Log Flow"

    steps:
      - name: Install Docker
        run: |
          sudo apt-get update -y
          sudo apt-get install -y docker.io
          sudo systemctl start docker

      - name: Check rsyslog service status
        run: |
          echo "[Checking Rsyslog status inside container]"
          docker exec rsyslog-server systemctl status rsyslog --no-pager || echo "Rsyslog may not be running"

      - name: Inspect remote log directory
        run: |
          echo "[Listing remote logs]"
          docker exec rsyslog-server ls -l /var/log/remote || true
          echo "[Showing log content]"
          docker exec rsyslog-server cat /var/log/remote/*.log || echo "No remote logs found"

  cleanup:
    runs-on: ubuntu-latest
    if: always()
    needs: [build-server, test-grafana, test-loki-promtail, test-rsyslog]
    name: "Cleanup Containers"

    steps:
      - name: Remove containers and network
        run: |
          docker rm -f rsyslog-server || true
          docker network rm lognet || true
